## Codebase Patterns
- Use `wa-crypt-tools` venv: `./wa-crypt-tools/bin/python`
- Run tools via module: `python -m flake8`, `python -m mypy`
- Package calls: `python -m wa_crypt_tools`
- Use `unittest.mock` to simulate ADB for testing
- Use `--internal` flag pattern for commands needing venv/specific deps (public API calls subprocess)

## 2026-01-29 - US-001
- Implemented `wa_crypt_tools` package structure.
- Created `pyproject.toml` with `flake8` and `mypy` config.
- Created empty modules: `adb`, `config`, `crypto`, `utils`.
- Verified with `mypy` and `flake8`.
- Files changed: `pyproject.toml`, `wa_crypt_tools/*`
- **Learnings for future iterations:**
  - The project uses a local venv named `wa-crypt-tools` (hyphen) but the package is `wa_crypt_tools` (underscore).
  - `flake8` and `mypy` were not installed; added them to the venv.
  - Future modules should be added to `wa_crypt_tools` and exposed in `__init__.py` if needed.
---

## 2026-01-29 - US-002
- Refactored configuration loading into `wa_crypt_tools/config.py`.
- Refactored venv management into `wa_crypt_tools/env_utils.py`.
- Added `get_script_dir` to `wa_crypt_tools/utils.py`.
- Verified with `tests/test_config_env.py` and linting tools.
- Files changed: `wa_crypt_tools/config.py`, `wa_crypt_tools/env_utils.py`, `wa_crypt_tools/utils.py`, `tests/test_config_env.py`
- **Learnings for future iterations:**
  - `argparse.Namespace` mocks in tests need explicit `None` values for expected keys to match `argparse` behavior.
  - Used `TypedDict` for `Config` to improve type safety across modules.
---

## 2026-01-29 - US-003
- Implemented `wa_crypt_tools/adb.py` with `get_adb_base`, `list_devices`, `get_product_model`.
- Added `AdbError` exception handling and typed functions.
- Verified with `tests/test_adb.py` using `unittest.mock`.
- Files changed: `wa_crypt_tools/adb.py`, `tests/test_adb.py`
- **Learnings for future iterations:**
  - `flake8` requires 2 blank lines before top-level functions/classes.
  - Used `unittest.mock.patch` to avoid actual ADB calls during testing.
---

## 2026-01-29 - US-004
- Implemented `wa_crypt_tools/commands/pull.py` encapsulating pull logic.
- Created `tests/test_cmd_pull.py` with full mocking of ADB and subprocess calls.
- Verified type safety with mypy and formatting with flake8.
- Files changed: `wa_crypt_tools/commands/pull.py`, `wa_crypt_tools/commands/__init__.py`, `tests/test_cmd_pull.py`
- **Learnings for future iterations:**
  - `flake8` is strict about line length (79 chars) and blank line whitespace.
  - `replace_file_content` tool requires careful handling of indentation blocks like `try/except`.
  - When wrapping long lines in lists/function calls, ensure clean indentation to avoid fighting the linter.
---

## 2026-01-29 - US-005
- Implemented `wa_crypt_tools/commands/push.py` with `push_whatsapp` logic.
- Created `tests/test_cmd_push.py` verifying push logic with mocked ADB.
- Updated `wa_crypt_tools/commands/__init__.py` to export `push_whatsapp`.
- Verified with `unittest`, `flake8`, and `mypy`.
- Files changed: `wa_crypt_tools/commands/push.py`, `tests/test_cmd_push.py`, `wa_crypt_tools/commands/__init__.py`, `wa_crypt_tools/CLAUDE.md`.
- **Learnings for future iterations:**
  - `wa_tool.py` push logic is simple `adb push` to `/sdcard/Android/media/com.whatsapp`.
  - `flake8` is very strict about line lengths (79 chars).
  - Ensure `__init__.py` exports match the actual function names in modules.
  - Using `unittest` + `mock` is robust for ADB commands without a real device.
---

## 2026-01-29 - US-006
- Implemented `wa_crypt_tools/commands/decrypt.py` handling database decryption.
- Created `tests/test_cmd_decrypt.py` verifying decryption logic with mocks.
- Updated `wa_crypt_tools/commands/__init__.py` to export `decrypt_database`.
- Verified with `unittest`, `flake8`, and `mypy` (in venv).
- Files changed: `wa_crypt_tools/commands/decrypt.py`, `wa_crypt_tools/commands/__init__.py`, `tests/test_cmd_decrypt.py`
- **Learnings for future iterations:**
  - `flake8` forbids unused imports (e.g., `pathlib.Path`) even if typed.
  - Strict line length (79 chars) requires careful wrapping.
  - Venv python path `./wa-crypt-tools/bin/python` is essential for running `mypy`/`flake8` correctly.
---

## 2026-01-29 - US-007
- Implemented `wa_crypt_tools/commands/convert.py` handling VCF conversion.
- Used internal/external pattern: Public `convert_vcf` calls `subprocess` to run module with `--internal`.
- Tested with `tests/test_cmd_convert.py` mocking subprocess calls.
- Updated `wa_crypt_tools/commands/__init__.py` to export `convert_vcf`.
- Documented pattern in `CLAUDE.md`.
- Verified with `mypy` and `flake8` (fixed issues).
- Files changed: `wa_crypt_tools/commands/convert.py`, `tests/test_cmd_convert.py`, `wa_crypt_tools/commands/__init__.py`, `wa_crypt_tools/CLAUDE.md`
- **Learnings for future iterations:**
  - `flake8` requires careful line wrapping (79 chars).
  - Used `--internal` flag to execute logic inside the venv from the main script.
  - `mypy` redundant ignores can be an issue if configuration changes.
---

## 2026-01-29 - US-008
- Implemented `wa_crypt_tools/commands/orchestrator.py` to coordinate pull, decrypt, and convert.
- Updated `wa_crypt_tools/__main__.py` to expose `all` subcommand and fix dispatch logic.
- Updated `wa_crypt_tools/commands/__init__.py`.
- Created `tests/test_cmd_orchestrator.py` with full mocking.
- Verified with `unittest`, `flake8`, and `mypy` (fixed multiple line-length and type issues).
- Files changed: `wa_crypt_tools/commands/orchestrator.py`, `wa_crypt_tools/__main__.py`, `wa_crypt_tools/commands/__init__.py`, `tests/test_cmd_orchestrator.py`, `wa_crypt_tools/CLAUDE.md`
- **Learnings for future iterations:**
  - `flake8` is extremely strict about line lengths (79 chars) and whitespace in `__main__.py` style dispatchers.
  - Mixing `argparse` namespace attributes with `TypedDict` (`Config`) requires explicit casting or careful handling for mypy.
  - `replace_file_content` can be dangerous with large replacement blocks if not precise; full file rewrite is safer for critical entry points when refactoring heavily.
---
